--[[⠀
----------------------------------------------------------------------------------------------------------------------------⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                       ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣀⣀⣀⣀⣀⣰⣦⣀⣀⠀⠠⠄⠄⠠⠀⠀⢀⣠⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣶⡿⢿⣦⠀⠀⠀⠀⠀⠀⠀⢀⡷⠀⠀⠀⠀⠀⣀⠀⠀⠀⠀⠀⣩⡿⠋⠙⠉⢩⡿⠟⠀⠀⠀⠀⠀⠀⢀⣶⣾⠟⠋⠛⣿⣷⡄⠀⠀⠀⠀⠀⣴⣿⠂⠀⠀⣼⡿⠀⠀⠀⠀⠀⠀⢀⣠⡴⠶⣤⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠦⠤⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⡿⠋⠀⢸⠏⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⢠⡇⠀⠀⠀⢠⣾⠋⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⢠⣿⠋⠀⠀⠀⠀⠛⠛⠁⠀⠀⠀⢀⣾⣿⠏⠀⠀⢀⡿⠃⠀⠀⠀⠀⠀⠶⠋⠁⢀⣰⠟⠀⠀⠀⠀⠀⠀⠀⣹⣿⠀⠀⠀⠀⣨⣿⠇⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⢀⣠⣤⣴⣶⠆⠀⠀⠀⠀⠀⢰⠃⠀⠀⠀⠀⠀⣾⠀⠀⠀⣰⣿⠃⠀⠀⠀⠀⠀⣿⡀⠀⠀⠀⠀⠀⢀⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⠋⠀⠀⢀⡾⠁⠀⠀⠀⠀⠀⠀⠀⣠⣶⣯⣅⡀⠀⠀⠀⠀⠀⠀⠀⣿⡇⢀⣠⠴⠞⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣸⡟⠀⠛⠉⣠⣾⠃⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⠀⢿⣤⡴⢺⢻⠃⠀⠀⠀⠀⠀⢸⡿⠁⠀⠀⠀⠀⠀⠀⢿⠀⠀⠀⠀⢀⣤⠀⠀⠀⠀⠀⢀⣿⣇⡤⠤⢤⣾⣤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢻⡆⠀⠀⠀⠀⠀⣿⣯⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣿⠃⠀⠀⢀⣼⠇⠀⠀⠀⠀⠀⠀⣰⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢂⠇⠀⠀⠀⠀⠀⠀⣾⡅⠀⠀⠀⠀⠀⠀⠀⢸⣧⡀⠀⠀⣼⠇⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠐⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⠀⢰⡏⠘⣦⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠘⢧⣤⡶⠟⢻⠀⠀⠀⠀⠀⠀⢠⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢘⠏⠀⠀⠀⠀⠀⠀⢰⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠙⠿⣶⡾⠋⠀⠀⠀⠀⠀⠀⢸⡟⠀⠀⠀⢰⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠞⠁⠀⠀⠀⠀⠀⠀⠁⠀⠈⠙⠂⠔⠊⠁⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⢀⣿⣤⠶⠒⠒⠁⠀⠀⠀⠀⢠⠏⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠐⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

----------------------------------------------------------------------------------------------------------------------------
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
Please contact me if you need to hire someone to do mods or other design related tasks
https://steamcommunity.com/id/glytch3r/myworkshopfiles/
https://ko-fi.com/glytch3r
Discord: Glytch3r#1337 / glytch3r
----------------------------------------------------------------------------------------------------------------------------
--]]
require "lua_timers"
BunkerStaff = BunkerStaff or {}

BunkerStaff.range = 12
BunkerStaff.AttackRange = 6
BunkerStaff.AlertRange = BunkerStaff.AttackRange * 2
BunkerStaff.adminMarker = false
BunkerStaff.marker = nil
BunkerStaff.zed=nil
BunkerStaff.marker2 = nil
BunkerStaff.ticks = 0
BunkerStaff.markerDist = 25
BunkerStaff.Gun = "Base.VarmintRifle"
BunkerStaff.Drop = {"Base.223Bullets", "Base.223Bullets", "Base.223Bullets", "Base.223Bullets", "Base.223Box", "Base.223Box"}
BunkerStaff.DropExtra = {"IronSight", "x2Scope", "x4Scope", "x8Scope"}

local femaleText =  {
	"FemaleBody01",
	"FemaleBody02",
	"FemaleBody03",
	"FemaleBody04",
	"FemaleBody05",
}

local maleText =  {
	"MaleBody01",
	"MaleBody01a",
	"MaleBody02",
	"MaleBody02a",
	"MaleBody03",
	"MaleBody03a",
	"MaleBody04",
	"MaleBody04a",
	"MaleBody05",
	"MaleBody05a",
}
local humanText =  {
	["MaleBody01"] = true ,
	["MaleBody01a"] = true ,
	["MaleBody02"] = true ,
	["MaleBody02a"] = true ,
	["MaleBody03"] = true ,
	["MaleBody03a"] = true ,
	["MaleBody04"] = true ,
	["MaleBody04a"] = true ,
	["MaleBody05"] = true ,
	["MaleBody05a"] = true ,
	["FemaleBody01"] = true ,
	["FemaleBody02"] = true ,
	["FemaleBody03"] = true ,
	["FemaleBody04"] = true ,
	["FemaleBody05"] = true ,
}


-----------------------     is*          ---------------------------



function BunkerStaff.isNPCHumanSkin(zed)
	local ztex = tostring(zed:getHumanVisual():getSkinTexture())
	if not humanText[ztex] then
		return false
	end
	return true
end

-----------------------     set*          ---------------------------


function BunkerStaff.setNPCSkin(zed)
	--if zed:getHumanVisual() then
	local txt = nil
	if zed:isFemale() then
		txt = tostring(femaleText[ZombRand(1, #femaleText+1)])
	else
		txt = tostring(maleText[ZombRand(1, #maleText+1)])
	end
	zed:getHumanVisual():setSkinTextureName(txt)
	--end
	zed:resetModelNextFrame()
end


function BunkerStaff.setRandWalk(zed)
	zed:setWalkType(tostring(ZombRand(1,6)));
end


-----------------------  gun* arm*             ---------------------------
function BunkerStaff.armWeapon(zed)
	local gun = BunkerStaff.Gun
	local inv = zed:getInventory()
	if not inv:contains(gun) then
		local wpn = inv:AddItem(InventoryItemFactory.CreateItem(gun));
		zed:setPrimaryHandItem(wpn)
		zed:setSecondaryHandItem(wpn)
		luautils.equipItems(zed, wpn, wpn)
	end
end
-----------------------   cmd*            ---------------------------
function BunkerStaff.findID(int)
	local zombies = getCell():getObjectList()
	for i=zombies:size(),1,-1 do
		local zed = zombies:get(i-1)
		if instanceof(zed, "IsoZombie") then
			local zedId=tostring(zed:getOnlineID())
			if zedId and zedId == tostring(int) then return zed end
		end
	end
	return nil
end

-----------------------     corpse* kill*     act*   do*   ---------------------------
--zed:knockDown(true)

-----------------------    getzeds* table* get*   count*  npc*      ---------------------------
--[[

function BunkerStaff.getZeds(point)
	local range = (BunkerStaff.AlertRange * 2) + 1
	local zeds = {}
	local objs = getCell():getObjectList()
	for i=objs:size(), 1, -1 do
		local zed = objs:get(i-1)
		if zed and instanceof(zed, "IsoZombie") then
			if BunkerStaff.getDist(point, zed) <= range then
				table.insert(zeds, zed)
			end
		end
	end
	return zeds
end
]]

function BunkerStaff.getZeds(point)
	local rad = BunkerStaff.AlertRange
	local zeds = {}
	local x, y, z = point:getX(), point:getY(), point:getZ()
	for xDelta = -rad, rad do
		for yDelta = -rad, rad do
			local sq = getCell():getOrCreateGridSquare(x + xDelta, y + yDelta, z)
			for i=0, sq:getMovingObjects():size()-1 do
				local zed = sq:getMovingObjects():get(i)
				if zed and instanceof(zed, "IsoZombie") then
					table.insert(zeds, zed)
				end
			end
		end
	end
	return zeds
end

function BunkerStaff.getZedCount(point)
	local range = BunkerStaff.range
	local count = 0
	local objs = getCell():getObjectList()
	for i=objs:size(), 1, -1 do
		local zed = objs:get(i-1)
		if zed and instanceof(zed, "IsoZombie") then
			if BunkerStaff.getDist(point, zed) <= range then
				count = count + 1
			end
		end
	end
	return count
end


-----------------------               ---------------------------

function BunkerStaff.areNoZeds(point)
	local zeds = BunkerStaff.getZeds(point)
	return #zeds == 0
end

function BunkerStaff.isSafe(zed)
    local chillDistance = BunkerStaff.AlertRange + 1
    local targ = BunkerStaff.getTarget(zed)
    if targ == nil then return true end
    if targ and BunkerStaff.getDist(zed, targ) >= chillDistance then return true end
    if BunkerStaff.areNoZeds(zed) then return true end
	return false
end
-----------------------               ---------------------------
--[[
function BunkerStaff.setOutfit(zed, outfit)
	local id = zed:getPersistentOutfitID()
	zed:dressInNamedOutfit(outfit);
	if id ~= zed:getPersistentOutfitID() then
		NPC_ID_DATA[id] = nil
	end
	NPC_ID_DATA[zed:getPersistentOutfitID()] = true
	sendClientCommand("BunkerStaff", "Save", { data = NPC_ID_DATA})

	zed:DoZombieInventory()
	zed:resetModelNextFrame()
	print(tostring(zed:getOutfitName()))
end]]
-----------------------   clear* remove*
function BunkerStaff.removeNPC(zed)
	if BunkerStaff.isZedNPC(zed) then
		zed:changeState(ZombieOnGroundState.instance())
		zed:setAttackedBy(getCell():getFakeZombieForHit())
		zed:becomeCorpse()
	end
end
-----------------------          safe*     ---------------------------
function BunkerStaff.areNoZeds(point)
	local zeds = BunkerStaff.getZeds(point)
	return #zeds == 0
end

function BunkerStaff.isSafe(zed)
    local chillDistance = BunkerStaff.AlertRange + 1
    local targ = BunkerStaff.getTarget(zed)
    if targ == nil then return true end
    if targ and BunkerStaff.getDist(zed, targ) >= chillDistance then return true end
    if BunkerStaff.areNoZeds(zed) then return true end
	return false
end
-----------------------     get*      dist*    ---------------------------

function BunkerStaff.getDist(zed, targ)
    if zed and targ then
        return math.floor(IsoUtils.DistanceTo(zed:getX(), zed:getY(), targ:getX(), targ:getY()))
    end
    return nil
end
-----------------------
function BunkerStaff.hasNpc(sq)
	local zed = sq:getZombie()
    if sq and zed and BunkerStaff.isNPCZed(zed) then return true end
	return false
end

-----------------------      end*         ---------------------------


------------------------ marker*  mark*    distance* range*    ---------------------------
--[[
local function getTargDist(zed, targ, range)
	if not (zed or targ) then return false end
	local dist = math.floor(IsoUtils.DistanceTo(zed:getX(), zed:getY(), targ:getX() , targ:getY()))
	if dist <= range then
		return true
	end
	return false
end
local r,g,b=0.6,1,10
local r2,g2,b2=1,0.5,0.5
function BunkerStaff.addzedmarks(zed, pl)
	if not (pl or zed) then return end
	local marker = nil
--	if zed:getModData()['isNPCMarked'] == nil then zed:getModData()['isNPCMarked'] = false end
	--if not zed:getModData()['isNPCMarked'] == true then
		local targ =  zed:getTarget()
		if targ == pl then
			marker = getWorldMarkers():addPlayerHomingPoint(pl, zed:getX(), zed:getY(), r2, g2, b2, 5);
		else
			marker = getWorldMarkers():addPlayerHomingPoint(pl, zed:getX(), zed:getY(), r, g, b, 5);
		end
	--	zed:getModData()['isNPCMarked'] = true
	--end
	timer:Simple(3, function()
		if marker then marker:remove() end
		if zed then zed:getModData()['isNPCMarked'] = nil end
	end)
end
function BunkerStaff.addNPCMarker(zed)
	if not zed then return end
	BunkerStaff.ticks = BunkerStaff.ticks +1
	local pl = getPlayer()
	if not pl then return end
	if BunkerStaff.ticks % 300 == 0 then
		if getTargDist(zed, pl, BunkerStaff.markerDist) then
			BunkerStaff.addzedmarks(zed, pl)
		end
		BunkerStaff.ticks = 0
	end
end
]]

--[[
-----------------------     act*          ---------------------------
function BunkerStaff.getAct(zed, targ)

	local distance =  BunkerStaff.getDist(zed, targ)

    zed:setVariable('NPC_Action', 'idle')
    zed:setVariable('NPC_Action', 'aim')
    zed:setVariable('NPC_Action', 'attack')
    zed:setVariable('NPC_Action', 'reload')
    zed:setVariable('NPC_Action', 'move')



	if distance <= BunkerStaff.AttackRange then
		zed:setVariable('ActNPC', 'isZedAttack')
		zed:setVariable('NPC_Action', 'attack')
	elseif distance <= BunkerStaff.AlertRange then
		zed:setVariable('ActNPC', 'isReady')
		zed:setVariable('NPC_Action', 'aim')
		zed:setVariable('NPC_Action', 'move')
	elseif  distance <= BunkerStaff.range then
		zed:setVariable('ActNPC', 'NPC_Chill')
	end

end
]]


