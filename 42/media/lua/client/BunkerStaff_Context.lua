--[[⠀
----------------------------------------------------------------------------------------------------------------------------⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                       ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣀⣀⣀⣀⣀⣰⣦⣀⣀⠀⠠⠄⠄⠠⠀⠀⢀⣠⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣶⡿⢿⣦⠀⠀⠀⠀⠀⠀⠀⢀⡷⠀⠀⠀⠀⠀⣀⠀⠀⠀⠀⠀⣩⡿⠋⠙⠉⢩⡿⠟⠀⠀⠀⠀⠀⠀⢀⣶⣾⠟⠋⠛⣿⣷⡄⠀⠀⠀⠀⠀⣴⣿⠂⠀⠀⣼⡿⠀⠀⠀⠀⠀⠀⢀⣠⡴⠶⣤⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠦⠤⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⡿⠋⠀⢸⠏⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⢠⡇⠀⠀⠀⢠⣾⠋⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⢠⣿⠋⠀⠀⠀⠀⠛⠛⠁⠀⠀⠀⢀⣾⣿⠏⠀⠀⢀⡿⠃⠀⠀⠀⠀⠀⠶⠋⠁⢀⣰⠟⠀⠀⠀⠀⠀⠀⠀⣹⣿⠀⠀⠀⠀⣨⣿⠇⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⢀⣠⣤⣴⣶⠆⠀⠀⠀⠀⠀⢰⠃⠀⠀⠀⠀⠀⣾⠀⠀⠀⣰⣿⠃⠀⠀⠀⠀⠀⣿⡀⠀⠀⠀⠀⠀⢀⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⠋⠀⠀⢀⡾⠁⠀⠀⠀⠀⠀⠀⠀⣠⣶⣯⣅⡀⠀⠀⠀⠀⠀⠀⠀⣿⡇⢀⣠⠴⠞⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣸⡟⠀⠛⠉⣠⣾⠃⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⠀⢿⣤⡴⢺⢻⠃⠀⠀⠀⠀⠀⢸⡿⠁⠀⠀⠀⠀⠀⠀⢿⠀⠀⠀⠀⢀⣤⠀⠀⠀⠀⠀⢀⣿⣇⡤⠤⢤⣾⣤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢻⡆⠀⠀⠀⠀⠀⣿⣯⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣿⠃⠀⠀⢀⣼⠇⠀⠀⠀⠀⠀⠀⣰⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢂⠇⠀⠀⠀⠀⠀⠀⣾⡅⠀⠀⠀⠀⠀⠀⠀⢸⣧⡀⠀⠀⣼⠇⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠐⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⠀⢰⡏⠘⣦⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠘⢧⣤⡶⠟⢻⠀⠀⠀⠀⠀⠀⢠⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢘⠏⠀⠀⠀⠀⠀⠀⢰⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠙⠿⣶⡾⠋⠀⠀⠀⠀⠀⠀⢸⡟⠀⠀⠀⢰⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠞⠁⠀⠀⠀⠀⠀⠀⠁⠀⠈⠙⠂⠔⠊⠁⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⢀⣿⣤⠶⠒⠒⠁⠀⠀⠀⠀⢠⠏⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠐⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

----------------------------------------------------------------------------------------------------------------------------
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
Please contact me if you need to hire someone to do mods or other design related tasks
https://steamcommunity.com/id/glytch3r/myworkshopfiles/
https://ko-fi.com/glytch3r
Discord: Glytch3r#1337 / glytch3r



----------------------------------------------------------------------------------------------------------------------------
--]]


-----------------------               ---------------------------

BunkerStaff = BunkerStaff or {}
BunkerStaff.WasHurt = false
BunkerStaff.IgnorePlayer = false


local acts = {
	'Disassemble',
	'Drink',
	'WashHands',
	'WriteJournal',
	'Forage',
	'Looting'
}
-----------------------     context*          ---------------------------
function BunkerStaff.doTrade()
    pl = pl or getPlayer()
    if not pl or not pl:isAlive() then return false end

    local inv = pl:getInventory()
    local card = "Base.RationCard"
    local cost = SandboxVars.BunkerStaff.tradeCost or 50

    local cardCount = inv:getItemCount(card)
    if cardCount < cost then return false end

    for i = 1, cost do
        local item = inv:FindAndReturn(card)
        if item then
            inv:Remove(item)
        end
    end

    return true
end


function BunkerStaff.isCanTrade(pl)
	pl = pl or getPlayer()
	if not pl or not pl:isAlive() then return false end
	local cost = SandboxVars.BunkerStaff.tradeCost or 50
	local inv = pl:getInventory() 	
	local cardCount = inv:getItemCount("Base.RationCard")
	return cardCount  >= cost
end

function BunkerStaff.Context(player, context, worldobjects)
	local pl = getSpecificPlayer(player)
	if not pl then return end
	local sq = nil

	local sq = ISWorldObjectContextMenu.fetchVars.clickedSquare 
	if not sq then return end
	local zed = sq:getZombie()
	if not zed then return end
	
	if BunkerStaff.isNPCZed(zed) then
		local Main = context:addOptionOnTop("NPC:")
		local interact = ISContextMenu:getNew(context)
		context:addSubMenu(Main, interact)
		Main.iconTexture = getTexture("media/ui/NPC_Blue.png")
		
		local tip = ISWorldObjectContextMenu.addToolTip()
		local tip2 = ISWorldObjectContextMenu.addToolTip()

		local optClick = interact:addOption("Interact", worldobjects, function()
			BunkerStaff.sayMsg(zed, "interact")
		end)
		optClick.iconTexture = getTexture("media/ui/NPC_Orange.png")		
		tip.description = "Interact"
		-----------------------            ---------------------------
		local optClick2 = interact:addOption("Trade", worldobjects, function()
			if BunkerStaff.doTrade() then 
				BunkerStaff.pause(1.5, function()
					BunkerStaff.doSleep()			
				end)
			end
			BunkerStaff.sayMsg(zed) 
		end)
		optClick2.iconTexture = getTexture("media/ui/NPC_Green.png")
		
		tip2.description = "Trade"
		local tipMsg = "Bunker Staff NPC"
		BunkerStaff.WasHurt =  BunkerStaff.WasHurt or false

		if BunkerStaff.WasHurt then
			tipMsg =  "Bunker Staff is Hurt"
		end
		if  BunkerStaff.WasHurt then
			optClick.notAvailable = true
			optClick2.notAvailable = true
		end
		tip.description = tostring(tipMsg)
		optClick.toolTip = tip
		if not BunkerStaff.isCanTrade(pl) then
			optClick2.notAvailable = true
			optClick2.iconTexture = getTexture("media/ui/NPC_Red.png")

			tipMsg =  "Not enough Ration Cards: ".. tostring(cardCount).." / 50"
		end
		tip2.description = tostring(tipMsg)
		optClick2.toolTip = tip2
	end

	if getCore():getDebug() then 	
		local menu2 = context:addOptionOnTop("NPC:")
		local dbgOpts = ISContextMenu:getNew(context)
		context:addSubMenu(menu2, dbgOpts)
		menu2.iconTexture = getTexture("media/ui/NPC_Blue.png")
			
		local optClick2 = dbgOpts:addOptionOnTop("TP Near Bunker", worldobjects, function()
			BunkerStaff.tp2()
		end)
		local optClick2 = dbgOpts:addOptionOnTop("Z -4", worldobjects, function()
			pl:setZ(-4)
		end)
		local optClick2 = dbgOpts:addOptionOnTop("Z 0", worldobjects, function()
			pl:setZ(0)
		end)
		local optClick2 = dbgOpts:addOptionOnTop("+RationCards x50", worldobjects, function()
			local inv = pl:getInventory()
			local fType = "Base.RationCard"
			inv:AddItems(fType)
		end)


		local optClick2 = dbgOpts:addOptionOnTop("Items Check", worldobjects, function()	
			local fullTypes = {
				"Base.BellyButton_RingSilver",
				"Base.Bra_Straps_FrillyBlack",
				"Base.Gloves_LongWomenGloves",
				"Base.HolsterAnkle",
				"Base.Shoes_Fancy",
				"Base.StockingsBlack",
				"Base.FrillyUnderpants_Black",
				"Base.Makeup_LipsBlack",
				"Base.Makeup_EyesShadowBlue",
				"Base.RationCard",
			}

			for _, fType in ipairs(fullTypes) do
				local item = ScriptManager.instance:FindItem(fType)
				if item then
					local name = item:getDisplayName()
					print(fType .. " -> " .. name)
				else
					print(fType .. " -> [NOT FOUND]")
				end
			end
		end)




	end
end
Events.OnFillWorldObjectContextMenu.Remove(BunkerStaff.Context)
Events.OnFillWorldObjectContextMenu.Add(BunkerStaff.Context)
-----------------------               ---------------------------

--[[
	local icon = getTexture("media/ui/NPC_Gray.png")
	local icon = getTexture("media/ui/NPC.png")
	local icon = getTexture("media/ui/NPC_Orange.png")
	local icon = getTexture("media/ui/NPC_Blue.png")
	local icon = getTexture("media/ui/NPC_Red.png")
	local icon = getTexture("media/ui/NPC_Green.png")
]]

		---------------------------


--[[ 
function BunkerStaff.doTrade()
	local removed = 0
	pl = pl or getPlayer()
	if not pl or not pl:isAlive() then return end
	local inv = pl:getInventory() 

	local cardCount = inv:getItemCount("Base.RationCard")
	local hasRationCards = cardCount  >= 50
	if hasRationCards then
		local inv = pl:getInventory()
		for j = inv:getItems():size()-1, 0, -1 do
			local item = inv:get(j)
			if item and item:getFullType() == "Base.Ration" then
				inv:Remove(item)
				removed = removed + 1
				if removed >= 50 then
					return true
				end
			end
		end
	end
    return false	
end

 ]]